<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Termékek nyilvántartása</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
        integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="index.css">
</head>

<body>
    <div class="container">
        <h1 class="text-center my-5">Termékek</h1>
        <div class="overflow-x-auto">
            <table id="products" class="table table-bordered table-striped" style="min-width: 810px;">
                <thead>
                    <tr>
                        <th>Név</th>
                        <th>EAN - International Article Number</th>
                        <th>Ár - Ft</th>
                        <th>Raktáron - db</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <div class="form-floating">
                                <input type="text" id="nameInput" placeholder="Név" class="form-control">
                                <label for="nameInput">Név</label>
                            </div>
                        </td>
                        <td>
                            <div class="form-floating">
                                <input type="text" id="eanInput" placeholder="EAN" class="form-control">
                                <label for="eanInput">EAN</label>
                            </div>
                        </td>
                        <td>
                            <div class="form-floating">
                                <input type="number" min="0" step="1000" id="priceInput" placeholder="Ár" class="form-control">
                                <label for="priceInput">Ár - Ft</label>
                            </div>
                        </td>
                        <td>
                            <div class="form-floating">
                                <input type="number" min="0" id="warehouseInput" placeholder="Raktáron - db" class="form-control">
                                <label for="warehouseInput">Raktáron - db</label>
                            </div>
                        </td>

                        <td>
                            <button id="addButton" class="btn btn-primary w-100"><i class="fa fa-plus"></i></button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <dialog id="editDialog" class="p-4">
        <h2>Szerkesztés</h2>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Név</th>
                    <th>EAN - International Article Number</th>
                    <th>Ár - Ft</th>
                    <th>Raktáron - db</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><input type="text" id="editNameInput" class="form-control"></td>
                    <td><input type="text" id="editEanInput" class="form-control"></td>
                    <td><input type="number" id="editPriceInput" class="form-control"></td>
                    <td><input type="number" id="editWarehouseInput" class="form-control"></td>
                </tr>
            </tbody>
        </table>
        <div class="d-flex justify-content-between">
            <button id="editCancelButton" class="btn btn-danger">Elvetés</button>
            <button id="editDoneButton" class="btn btn-success">Kész</button>
        </div>
    </dialog>
</body>

<script>
    if (localStorage.getItem("data") == null) {
        localStorage.setItem("data", "[]")
    }

    const data = JSON.parse(localStorage.getItem("data"));

    const currencyFormatOptions = { style: "currency", currency: "HUF" };
    const currencyFormat = new Intl.NumberFormat("hu-HU", currencyFormatOptions);

    const table = document.getElementById("products");

    const nameInput = document.getElementById("nameInput");
    const eanInput = document.getElementById("eanInput");
    const priceInput = document.getElementById("priceInput");
    const warehouseInput = document.getElementById("warehouseInput");
    const addButton = document.getElementById("addButton");

    const editDialog = document.getElementById("editDialog");
    const editNameInput = document.getElementById("editNameInput");
    const editEanInput = document.getElementById("editEanInput");
    const editPriceInput = document.getElementById("editPriceInput");
    const editWarehouseInput = document.getElementById("editWarehouseInput");
    const editCancelButton = document.getElementById("editCancelButton");
    const editDoneButton = document.getElementById("editDoneButton");

    // Add new data
    addButton.addEventListener("click", () => {
        let product = {};

        // find first available id
        let id = 0;
        while (data.find(x => x.id === id) !== undefined) {
            id++;
        }
        product.id = id;

        let price = Number(priceInput.value);
        let warehouse = Number(warehouseInput.value);

        // validation
        if (!validateInput(nameInput.value.trim(), eanInput.value.trim(), price, warehouse, null)) {
            return;
        }

        product.name = nameInput.value.trim();
        product.ean = eanInput.value.trim();
        product.price = price;
        product.warehouse = warehouse;

        data.push(product);
        addLine(product);

        nameInput.value = null;
        eanInput.value = null;
        priceInput.value = null;
        warehouseInput.value = null;

        saveData();
    });

    // edit cancel button
    editCancelButton.addEventListener("click", () => {
        editDialog.close();
    });

    // populate table
    data.forEach(element => {
        addLine(element);
    });

    // helper for adding lines
    function addLine(object) {
        let row = table.insertRow(table.rows.length - 1);

        row.insertCell(-1).textContent = object.name;
        row.insertCell(-1).textContent = object.ean;
        row.insertCell(-1).textContent = currencyFormat.format(object.price);
        row.insertCell(-1).textContent = object.warehouse;
        if (object.warehouse < 10) {
            row.cells[row.cells.length - 1].classList.add("warehouseWarning");
        }

        let editButton = `<button class="btn btn-secondary w-100 mb-1" id="edit-${object.id}"><i class="fa fa-pencil"></i></button>`;
        let deleteButton = `<button class="btn btn-danger w-100 mt-1" id="delete-${object.id}"><i class="fa fa-trash"></i></button>`;

        row.insertCell(-1).innerHTML = editButton + deleteButton;

        // edit button
        let editDOMButton = document.getElementById(`edit-${object.id}`);
        editDOMButton.addEventListener("click", () => {
            editNameInput.value = object.name;
            editNameInput.placeholder = object.name;

            editEanInput.value = object.ean;
            editEanInput.placeholder = object.ean;

            editPriceInput.value = object.price;
            editPriceInput.placeholder = currencyFormat.format(object.price);

            editWarehouseInput.value = object.warehouse;
            editWarehouseInput.placeholder = object.warehouse;

            // set function to edit done button
            editDoneButton.onclick = function () {
                // set back to default if removed
                if (editNameInput.value.trim().length === 0) {
                    editNameInput.value = object.name;
                }
                if (editEanInput.value.trim().length === 0) {
                    editEanInput.value = object.ean;
                }
                if (editPriceInput.value.trim().length === 0) {
                    editPriceInput.value = object.price;
                }
                if (editWarehouseInput.value.trim().length === 0) {
                    editWarehouseInput.value = object.warehouse;
                }

                let price = Number(editPriceInput.value);
                let warehouse = Number(editWarehouseInput.value);

                // validate
                if (!validateInput(editNameInput.value.trim(), editEanInput.value.trim(), price, warehouse, object.ean)) {
                    return;
                }

                // change values
                row.cells[0].textContent = editNameInput.value;
                object.name = editNameInput.value;
                row.cells[1].textContent = editEanInput.value;
                object.ean = editEanInput.value;
                row.cells[2].textContent = currencyFormat.format(price);
                object.price = price
                row.cells[3].textContent = warehouse;
                object.warehouse = warehouse;
                if (warehouse < 10) {
                    row.cells[row.cells.length - 2].classList.add("warehouseWarning");
                } else {
                    row.cells[row.cells.length - 2].classList.remove("warehouseWarning");
                }

                editDialog.close();
                saveData();
            };

            editDialog.showModal();
        });

        // delete button
        let deleteDOMButton = document.getElementById(`delete-${object.id}`);
        deleteDOMButton.addEventListener("click", () => {
            let dataIndex = data.findIndex((e) => e.id == object.id);
            if (confirm(`Biztos hogy törölni szeretné a következőt: ${data[dataIndex].name}`)) {
                data.splice(dataIndex, 1);
                table.deleteRow(row.rowIndex)
                saveData();
            }
        });
    }

    // helper for error checking
    function validateInput(name, ean, price, warehouse, editEan) {
        let errors = [];

        // name
        if (!(name.trim().length > 0)) {
            errors.push("A név mező nem lehet üres!");
        }

        // ean
        if (ean.length != 13) {
            errors.push("Az EAN számnak 13 karakternek kell lennie!");
        }
        if (isNaN(Number(ean))) {
            errors.push("Az EAN szám csak számokat tartalmazhat!");
        }
        if (data.filter((x) => x.ean == ean && x.ean != editEan).length != 0) {
            errors.push("Ezt az EAN számot már tartalmazza az egyik termék!");
        }

        // price
        if (isNaN(price) || price <= 0) {
            errors.push("Az árnak 0-nál nagyobb számnak kell lennie!");
        }

        // warehouse
        if (isNaN(warehouse) || warehouse < 0) {
            errors.push("A raktáron darabszámnak 0 vagy nagyobb számnak kell lennie!");
        }

        if (errors.length > 0) {
            alert(errors.join("\n"));
            return false;
        }
        return true;
    }

    // save data to localstorage
    function saveData() {
        localStorage.setItem("data", JSON.stringify(data));
    }

    function saveExample() {
        localStorage.setItem("data", '[{"id": 0,"name": "Ritter Sport Bunter Mini Mix","ean": "4000417604811","price": 12790,"warehouse": 36},{"id": 1,"name": "Fractal Design Torrent Compact White RGB","ean": "7340172705239","price": 67126,"warehouse": 4},{"id": 2,"name": "Honeywell Xenon 1950 SR - USB kit","ean": "8595149009677","price": 50690,"warehouse": 23},{"id": 3,"name": "Logitech MX Master 3S Graphite","ean": "5099206103726","price": 38990,"warehouse": 12},{"id": 4,"name": "Samsung 980 PRO 1TB NVMe SSD","ean": "8806090295546","price": 46990,"warehouse": 8},{"id": 5,"name": "TP-Link Archer AX55 Wi-Fi 6 Router","ean": "4897098682678","price": 34990,"warehouse": 19}]')
    
        window.location.reload();
    }
</script>

</html>